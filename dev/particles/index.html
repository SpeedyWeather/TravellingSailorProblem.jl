<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Particle advection · TravellingSailorProblem.jl</title><meta name="title" content="Particle advection · TravellingSailorProblem.jl"/><meta property="og:title" content="Particle advection · TravellingSailorProblem.jl"/><meta property="twitter:title" content="Particle advection · TravellingSailorProblem.jl"/><meta name="description" content="Documentation for TravellingSailorProblem.jl."/><meta property="og:description" content="Documentation for TravellingSailorProblem.jl."/><meta property="twitter:description" content="Documentation for TravellingSailorProblem.jl."/><meta property="og:url" content="https://speedyweather.github.io/TravellingSailorProblem.jl/particles/"/><meta property="twitter:url" content="https://speedyweather.github.io/TravellingSailorProblem.jl/particles/"/><link rel="canonical" href="https://speedyweather.github.io/TravellingSailorProblem.jl/particles/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">TravellingSailorProblem.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../new_to_julia/">New to Julia?</a></li><li><a class="tocitem" href="../destination/">Destination</a></li><li class="is-active"><a class="tocitem" href>Particle advection</a><ul class="internal"><li><a class="tocitem" href="#Model-constructor"><span>Model constructor</span></a></li><li><a class="tocitem" href="#Particle-tracker"><span>Particle tracker</span></a></li><li><a class="tocitem" href="#Visualising-trajectories"><span>Visualising trajectories</span></a></li></ul></li><li><a class="tocitem" href="../evaluation/">Evaluation</a></li><li><span class="tocitem">TravellingSailorProblem challenge</span><ul><li><a class="tocitem" href="../instructions/">Instructions</a></li><li><a class="tocitem" href="../submit/">Submit</a></li><li><a class="tocitem" href="../leaderboard/">Leaderboard</a></li><li><a class="tocitem" href="../submissions/">List of submissions</a></li></ul></li><li><a class="tocitem" href="../functions_types/">Functions and types</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Particle advection</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Particle advection</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/TravellingSailorProblem.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/TravellingSailorProblem.jl/blob/main/docs/src/particles.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Particle-advection"><a class="docs-heading-anchor" href="#Particle-advection">Particle advection</a><a id="Particle-advection-1"></a><a class="docs-heading-anchor-permalink" href="#Particle-advection" title="Permalink"></a></h1><p>There are several steps for particle advection in SpeedyWeather. Particle advection in general is described in more detail in</p><ul><li><a href="https://speedyweather.github.io/SpeedyWeatherDocumentation/dev/particles/">Particle advection</a></li></ul><p>Generally we do,</p><pre><code class="language-julia hljs">using TravellingSailorProblem, SpeedyWeather

# how many particles do you want when creating a spectral grid
spectral_grid = SpectralGrid(nparticles=10)

# create a particle advection component, choose the layer it&#39;s on
particle_advection = ParticleAdvection2D(spectral_grid, layer=8)

# pass the particle advection to the model constructor
model = PrimitiveWetModel(spectral_grid; particle_advection)

# define particle tracker and add to the model
particle_tracker = ParticleTracker(spectral_grid)
add!(model, :particle_tracker =&gt; particle_tracker)</code></pre><p>which is now explained in more detail</p><h3 id="nparticles"><a class="docs-heading-anchor" href="#nparticles"><code>nparticles</code></a><a id="nparticles-1"></a><a class="docs-heading-anchor-permalink" href="#nparticles" title="Permalink"></a></h3><p>In SpeedyWeather, creating a <code>spectral_grid</code> means to choose the resolution so that every component knows of which size to allocate variables etc. Hence you have to decide here how many particles you want by passing on the <code>nparticles</code> keyword argument. The number of particles is then displayed</p><pre><code class="language-julia hljs">SpectralGrid(nparticles=100)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">SpectralGrid{Spectrum{...}, OctahedralGaussianGrid{...}}
├ Number format: Float32
├ Spectral:      T31 LowerTriangularMatrix
├ Grid:          48-ring OctahedralGaussianGrid, 3168 grid points
├ Resolution:    3.61°, 401km (at 6371km radius)
├ Particles:     100
├ Vertical:      8-layer atmosphere, 2-layer land
└ Architecture:  CPU using Array</code></pre><h3 id="ParticleAdvection2D"><a class="docs-heading-anchor" href="#ParticleAdvection2D"><code>ParticleAdvection2D</code></a><a id="ParticleAdvection2D-1"></a><a class="docs-heading-anchor-permalink" href="#ParticleAdvection2D" title="Permalink"></a></h3><p>By default, SpeedyWeather does not advect any particles. So you have to create a <code>ParticleAdvection2D</code> component (there is no 3D, yet, sorry!) and the <code>spectral_grid</code> has to be passed on as the first argument so the particle advection knows how many particles to advect!</p><pre><code class="language-julia hljs">ParticleAdvection2D(spectral_grid, layer=8)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ParticleAdvection2D{Float32} &lt;: SpeedyWeather.AbstractParticleAdvection
├ every_n_timesteps::Int64 = 6
├ layer::Int64 = 8
└ Δt::Base.RefValue{Float32} = Base.RefValue{Float32}(0.0f0)</code></pre><p>As the advection is in 2D, on a given layer of a SpeedyWeather simulation (so don&#39;t choose it higher than <code>nlayers</code> in <code>spectral_grid</code>!) you can choose the <code>layer</code> here too. Layers are numbered 1 at the top of the atmosphere to <code>nlayers</code> near the surface. There are other options but we won&#39;t change those.</p><h2 id="Model-constructor"><a class="docs-heading-anchor" href="#Model-constructor">Model constructor</a><a id="Model-constructor-1"></a><a class="docs-heading-anchor-permalink" href="#Model-constructor" title="Permalink"></a></h2><p>In SpeedyWeather, <code>PrimitiveWetModel</code> is the model that solves the primitive equations (widely used for weather forecasting) with humidity. It takes the <code>spectral_grid</code> as the first argument and then keyword arguments for every non-default model component. If you look at <code>model</code> it&#39;s quite lenghty as it shows every single model component, from numerics, to output to parameterizations that are used inside a simulation. But now <code>model.particle_advection</code> is just the particle advection we just created, it also lives inside the <code>model</code> now!</p><pre><code class="language-julia hljs">model = PrimitiveWetModel(spectral_grid; particle_advection)
model.particle_advection</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ParticleAdvection2D{Float32} &lt;: SpeedyWeather.AbstractParticleAdvection
├ every_n_timesteps::Int64 = 6
├ layer::Int64 = 8
└ Δt::Base.RefValue{Float32} = Base.RefValue{Float32}(0.0f0)</code></pre><h2 id="Particle-tracker"><a class="docs-heading-anchor" href="#Particle-tracker">Particle tracker</a><a id="Particle-tracker-1"></a><a class="docs-heading-anchor-permalink" href="#Particle-tracker" title="Permalink"></a></h2><p>So far the particles would fly but their trajectory wouldn&#39;t be tracked. For that we create a particle tracker as follows, again passing on <code>spectral_grid</code> as the first argument</p><pre><code class="language-julia hljs">particle_tracker = ParticleTracker(spectral_grid)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ParticleTracker{Float32} &lt;: AbstractCallback
├ schedule::Schedule = Schedule &lt;: SpeedyWeather.AbstractSchedule
├ every::Second = 14400 seconds
├ steps::Int64 = 0
├ counter::Int64 = 0
└── arrays: times, schedule
├ filename::String = particles.nc
├ path::String = 
├ compression_level::Int64 = 1
├ shuffle::Bool = false
├ keepbits::Int64 = 15
├ nparticles::Int64 = 10
├ netcdf_file::Nothing = nothing
└── arrays: lon, lat, σ</code></pre><p>There&#39;s many options but we won&#39;t touch those or elaborate them here. Important is however that creating a particle tracker doesn&#39;t mean it&#39;s part of the model. For this we do</p><pre><code class="language-julia hljs">add!(model, :particle_tracker =&gt; particle_tracker)</code></pre><p>As the <code>ParticleTracker</code> is implemented as a callback you can provide a key (a name) for it, like here <code>:particle_tracker</code> but you could also give it your own key like <code>:my_tracker</code> or simply do</p><pre><code class="language-julia hljs">add!(model, particle_tracker)</code></pre><p>in which case a random key is chosen as printed with an <code>[ Info:</code> note. But beware now we have added the same <code>particle_tracker</code> twice but with two different keys in which case the same <code>particle_tracker</code> will be called twice on every time step – probably not a good idea. You can always check which callbacks you have added with</p><pre><code class="language-julia hljs">model.callbacks</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{Symbol, SpeedyWeather.AbstractCallback} with 2 entries:
  :callback_nh75    =&gt; ParticleTracker{Float32} &lt;: AbstractCallback…
  :particle_tracker =&gt; ParticleTracker{Float32} &lt;: AbstractCallback…</code></pre><p>and delete callbacks with <code>delete!(model.callbacks, :key)</code>.  We delete one particle tracker by specifying its key, so that only the other one remains</p><pre><code class="language-julia hljs">delete!(model.callbacks, :particle_tracker)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{Symbol, SpeedyWeather.AbstractCallback} with 1 entry:
  :callback_nh75 =&gt; ParticleTracker{Float32} &lt;: AbstractCallback…</code></pre><p>Note that also the <code>children</code> are implemented as callbacks so you will likely see a list of both <code>Destination</code>s (the children) and the particle tracker!</p><div class="admonition is-category-warn" id="Do-not-add-one-particle-tracker-twice-with-different-keys-c8335fe089a14a97"><header class="admonition-header">Do not add one particle tracker twice with different keys<a class="admonition-anchor" href="#Do-not-add-one-particle-tracker-twice-with-different-keys-c8335fe089a14a97" title="Permalink"></a></header><div class="admonition-body"><p>Otherwise the second will interfere with the netCDF file created by the first.</p></div></div><h2 id="Visualising-trajectories"><a class="docs-heading-anchor" href="#Visualising-trajectories">Visualising trajectories</a><a id="Visualising-trajectories-1"></a><a class="docs-heading-anchor-permalink" href="#Visualising-trajectories" title="Permalink"></a></h2><p>Now let us also add some <code>children</code> as destinations</p><pre><code class="language-julia hljs">children = TravellingSailorProblem.children(10)
add!(model, children)</code></pre><p>which automatically uses their respective names as keys, you can check this with</p><pre><code class="language-julia hljs">model.callbacks</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{Symbol, SpeedyWeather.AbstractCallback} with 11 entries:
  :callback_nh75 =&gt; ParticleTracker{Float32} &lt;: AbstractCallback…
  :Elif          =&gt; Destination{Float32} &lt;: AbstractCallback…
  :Felipe        =&gt; Destination{Float32} &lt;: AbstractCallback…
  :Haruko        =&gt; Destination{Float32} &lt;: AbstractCallback…
  :Ana           =&gt; Destination{Float32} &lt;: AbstractCallback…
  :Diego         =&gt; Destination{Float32} &lt;: AbstractCallback…
  :Isla          =&gt; Destination{Float32} &lt;: AbstractCallback…
  :Gael          =&gt; Destination{Float32} &lt;: AbstractCallback…
  :Carla         =&gt; Destination{Float32} &lt;: AbstractCallback…
  :Jose          =&gt; Destination{Float32} &lt;: AbstractCallback…
  :Babu          =&gt; Destination{Float32} &lt;: AbstractCallback…</code></pre><p>Now we still need to initialize the model to obtain a simulation and run it!</p><pre><code class="language-julia hljs">simulation = initialize!(model)
run!(simulation, period=Day(41))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr36"><span class="sgr1">[ Info: </span></span>ParticleTracker writes to particles.nc as output=false</code></pre><p>After this is complete we can investigate the particle trajectories with <code>globe</code> passing on the particle tracker used and the children that were added to the model</p><pre><code class="language-julia hljs">using GLMakie, GeoMakie
globe(particle_tracker, children)</code></pre><p><img src="../trajectories1.png" alt/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../destination/">« Destination</a><a class="docs-footer-nextpage" href="../evaluation/">Evaluation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Thursday 30 October 2025 19:50">Thursday 30 October 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
